describe Spree::ApfusionOrderConcern do
  describe "#apfusion_order_placement" do

    before do
      shipping_category = Spree::ShippingCategory.create(name: "default")
      option_type = Spree::OptionType.create(name: "test", presentation: "test")
      option_value = Spree::OptionValue.create(name: "test", presentation: "test")
      product = Spree::Product.create(name: "testing", shipping_category_id: shipping_category.id, price: 81.76, apfusion_product_id: 96)
      stock_location = Spree::StockLocation.create(name: "Partners Fulfillment", state_id: state.id, country_id: country.id)
      Spree::Variant.create(sku: "560-69542", product_id: product.id, option_value_ids: option_value.id)
      variant.stock_items.last.update(count_on_hand: 100, stock_location_id: stock_location.id)
      shipping_method = Spree::ShippingMethod.new(shipping_category_ids: shipping_category.id, name: "Ground Shipping (FREE)")
      calculator = shipping_method.build_calculator(type: 'Spree::Calculator::Shipping::FlatRate', preferences: {:currency=>"USD", :amount=>0.0})
      state = Spree::State.create(name: "test", country_id: country.id)
      zone = Spree::Zone.new(name: "test")
      zone.zone_members.new(zoneable: country)
      zone.save
      shipping_method.zone_ids = [zone.id]
      shipping_method.save

      options = { q: { number_cont: 'R252971375' } }
      response = [{"id": 39283,"number": "R252971375","item_total": "81.76","total": "81.76","ship_total": "0.0","state": "complete","adjustment_total": "0.0","user_id": 63,"created_at": "2022-05-25T13:44:02.000Z","updated_at": "2022-05-27T22:27:55.000Z","completed_at": "2022-05-27T13:52:11.000Z","payment_total": "0.0","shipment_state": "shipped","payment_state": "balance_due","email": "James@CounselmanAuto.com","special_instructions": "APF: R252971375 - PL PO: 83888","channel": "spree","included_tax_total": "0.0","additional_tax_total": "0.0","display_included_tax_total": "$0.00","display_additional_tax_total": "$0.00","tax_total": "0.0","currency": "USD","considered_risky": false,"canceler_id": null,"customer_po": null,"notes": "Estimated Delivery Date: May 31, 2022","pw_work_order_id": "510595","pw_work_order_number": "149630","pw_purchase_order_number": "83888","pw_purchase_order_id": "247317","pw_delivery_ticket_id": null,"pw_delivery_ticket_number": null,"pw_delivery_ticket_revision": 0,"pw_invoice_id": null,"pw_invoice_number": null,"from_desktop": true,"error_description": null,"amount_detail": null,"total_parts_amount": null,"total_lineItemTax_amount": null,"display_item_total": "81.76","total_quantity": 1,"display_total": "81.76","display_ship_total": "0.0","display_tax_total": "$0.00","display_adjustment_total": "$0.00","token": "KJsVU6G2FNsCTGzQ9vxOMg1653486242443","rrw_user_id": 673,"user_email": "weldon@counselmanauto.com","checkout_steps": [  "address",  "delivery",  "payment",  "complete"],"bill_address": {  "id": 69944,  "firstname": "COUNSELMAN",  "lastname": " - MOBILE",  "full_name": "COUNSELMAN  - MOBILE",  "address1": "3019 ST STEPHENS RD",  "address2": "3019 ST STEPHENS ROAD",  "city": "MOBILE",  "zipcode": "36612",  "phone": "251-330-2700",  "company": "Counselman Automotive Recycling",  "alternative_phone": null,  "country_id": 232,  "state_id": 3520,  "state_name": null,  "state_text": "AL",  "email": "James@CounselmanAuto.com",  "customer_number": "4566551",  "country": {    "id": 232,    "iso_name": "UNITED STATES",    "iso": "US",    "iso3": "USA",    "name": "United States",    "numcode": 840  },  "state": {    "id": 3520,    "name": "Alabama",    "abbr": "AL",    "country_id": 232  }},"ship_address": {  "id": 69945,  "firstname": "COUNSELMAN",  "lastname": " - MOBILE",  "full_name": "COUNSELMAN  - MOBILE",  "address1": "3019 ST STEPHENS RD",  "address2": "3019 ST STEPHENS ROAD",  "city": "MOBILE",  "zipcode": "36612",  "phone": "251-330-2700",  "company": "Counselman Automotive Recycling",  "alternative_phone": null,  "country_id": 232,  "state_id": 3520,  "state_name": null,  "state_text": "AL",  "email": "James@CounselmanAuto.com",  "customer_number": "4566551",  "country": {    "id": 232,    "iso_name": "UNITED STATES",    "iso": "US",    "iso3": "USA",    "name": "United States",    "numcode": 840  },  "state": {    "id": 3520,    "name": "Alabama",    "abbr": "AL",    "country_id": 232  }},"line_items": [  {    "id": 40188,    "quantity": 1,    "price": "81.76",    "variant_id": 96,    "revenue": "115.0",    "pw_work_order_line_item_id": "962311",    "pw_purchase_order_line_item_id": "266749",    "pw_delivery_ticket_line_item_id": null,    "pw_invoice_line_item_id": null,    "total_state_prov_tax_amount": null,    "total_freight_amount": "0.0",    "total_freight_tax_amount": null,    "core": null,    "core_tax_amount": null,    "lineitem_description": null,    "total_revenue": null,    "total_county_tax_amount": "0",    "total_city_tax_amount": "0",    "variant": {      "product_id": 96,      "id": 96,      "name": "2009-2020 15x6 Toyota Corolla Steel Wheel / Rim",      "sku": "560-69542",      "price": "81.76",      "weight": "0.0",      "height": null,      "width": null,      "depth": null,      "is_master": true,      "slug": "2009-2015-15x6-toyota-corolla-steel-wheel-rim",      "description": "<p><strong>Features</strong></p>\r\n\r\n<ul>\r\n\t<li><b>&bull; </b>At Road Ready, we guarantee an easy direct fit every time</li>\r\n\t<li><b>&bull; </b>This wheel has been rigorously&nbsp;tested to meet all quality control standards</li>\r\n\t<li><b>&bull;&nbsp;</b>New OEM replica wheel</li>\r\n\t<li><b>&bull;&nbsp;</b>Guaranteed compatibility&nbsp;with all OE wheel covers and TPMS sensors</li>\r\n\t<li>&bull;&nbsp;We believe in our product - that&#39;s why we offer a 100% money back guarantee</li>\r\n\t<li><b>&bull; Free Shipping</b></li>\r\n</ul>\r\n\r\n<p><strong>Description</strong> This Road Ready wheel is perfect for a direct replacement or a full winter wheel swap. These rims are constructed to the highest quality measurements in the world and are engineered to withstand harsh conditions. <strong>Shipping</strong> Please see below for a detailed view of when our wheels are projected to get to you. <a href=\"https://www.roadreadywheels.com/shipping-policy/\" target=\"_blank\">Click here</a> for a complete view of our shipping policy. <img class=\"aligncenter\" src=\"https://www.roadreadywheels.com/wp-content/uploads/2016/04/shipping-map.jpg\" /> <strong>Return Policy</strong> We pride ourselves on customer service and stand by our quality 100%. If you receive your wheel and are not satisfied for whatever reason, give us a call, and we&#39;ll issue you a full refund and even pay for the shipping back!</p>\r\n",      "track_inventory": true,      "option_values": [],      "images": [        {          "id": 262,          "position": 1,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "Wheel Rim Illustration, 2009-2015 15x6 Toyota Corolla Steel Wheel Rim -Front Image",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUIwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--0df8e0030cc662b5853cdd0aa3e8e30e8ac2d540/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/69423.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUIwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--0df8e0030cc662b5853cdd0aa3e8e30e8ac2d540/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/69423.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUIwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--0df8e0030cc662b5853cdd0aa3e8e30e8ac2d540/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/69423.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUIwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--0df8e0030cc662b5853cdd0aa3e8e30e8ac2d540/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/69423.jpg"        },        {          "id": 263,          "position": 2,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "Wheel Rim Illustration, 2009-2015 15x6 Toyota Corolla Steel Wheel Rim - Back Image",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUYwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--1d03ed544e2fcd5829953920082d60b219171b9b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/69423-Back-copy.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUYwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--1d03ed544e2fcd5829953920082d60b219171b9b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/69423-Back-copy.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUYwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--1d03ed544e2fcd5829953920082d60b219171b9b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/69423-Back-copy.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUYwIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--1d03ed544e2fcd5829953920082d60b219171b9b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/69423-Back-copy.jpg"        },        {          "id": 264,          "position": 3,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "Wheel Rim Illustration, 2009-2015 15x6 Toyota Corolla Steel Wheel Rim - Side Image",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUowIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--9c89d079eaf290cf6bb4161c1f8b915dd1889eab/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/69423-Side.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUowIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--9c89d079eaf290cf6bb4161c1f8b915dd1889eab/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/69423-Side.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUowIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--9c89d079eaf290cf6bb4161c1f8b915dd1889eab/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/69423-Side.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBbUowIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--9c89d079eaf290cf6bb4161c1f8b915dd1889eab/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/69423-Side.jpg"        },        {          "id": 86324,          "position": 4,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "15  inch Rim",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeGR2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--4499bb88c60f88d165fa004788fb81eb25e88c85/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/15__Rim.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeGR2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--4499bb88c60f88d165fa004788fb81eb25e88c85/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/15__Rim.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeGR2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--4499bb88c60f88d165fa004788fb81eb25e88c85/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/15__Rim.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeGR2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--4499bb88c60f88d165fa004788fb81eb25e88c85/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/15__Rim.jpg"        },        {          "id": 86333,          "position": 5,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "Bolt Pattern Diagram",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeUJ2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--8a61c9ba28db39e06e0038c61a244f689d727982/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/Bolt_Pattern_Diagram.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeUJ2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--8a61c9ba28db39e06e0038c61a244f689d727982/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/Bolt_Pattern_Diagram.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeUJ2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--8a61c9ba28db39e06e0038c61a244f689d727982/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/Bolt_Pattern_Diagram.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBeUJ2QVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--8a61c9ba28db39e06e0038c61a244f689d727982/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/Bolt_Pattern_Diagram.jpg"        },        {          "id": 63306,          "position": 6,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBL1FVQVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--affa780ef54941d52fbee4fdb451ef223479d7ac/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/Tire_Size_Guide_All_Listings.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBL1FVQVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--affa780ef54941d52fbee4fdb451ef223479d7ac/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/Tire_Size_Guide_All_Listings.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBL1FVQVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--affa780ef54941d52fbee4fdb451ef223479d7ac/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/Tire_Size_Guide_All_Listings.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBL1FVQVE9PSIsImV4cCI6bnVsbCwicHVyIjoiYmxvYl9pZCJ9fQ==--affa780ef54941d52fbee4fdb451ef223479d7ac/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/Tire_Size_Guide_All_Listings.jpg"        },        {          "id": 4003,          "position": 7,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdmNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--4d9f29dbcb0ef80fd82b5789ae1cc6629e28744b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/560-69529-4_(1).jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdmNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--4d9f29dbcb0ef80fd82b5789ae1cc6629e28744b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/560-69529-4_(1).jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdmNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--4d9f29dbcb0ef80fd82b5789ae1cc6629e28744b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/560-69529-4_(1).jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdmNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--4d9f29dbcb0ef80fd82b5789ae1cc6629e28744b/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/560-69529-4_(1).jpg"        },        {          "id": 4007,          "position": 8,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdnNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--277b8dfa5a15e908cb069c998e88fd7663d0310f/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/560-69529-2_(1).jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdnNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--277b8dfa5a15e908cb069c998e88fd7663d0310f/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/560-69529-2_(1).jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdnNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--277b8dfa5a15e908cb069c998e88fd7663d0310f/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/560-69529-2_(1).jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdnNQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--277b8dfa5a15e908cb069c998e88fd7663d0310f/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/560-69529-2_(1).jpg"        },        {          "id": 4010,          "position": 9,          "attachment_content_type": null,          "attachment_file_name": null,          "type": "Spree::Image",          "attachment_updated_at": null,          "attachment_width": null,          "attachment_height": null,          "alt": "",          "viewable_type": "Spree::Variant",          "viewable_id": 96,          "mini_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdjRQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--3833e2ce03d007d8fc8e5a588cc729e06a4f411d/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lMTkRoNE5EZytCam9HUlZRPSIsImV4cCI6bnVsbCwicHVyIjoidmFyaWF0aW9uIn19--80d016c24cdea21fe6176a9d47f33c383908f182/560-69529-3.jpg",          "small_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdjRQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--3833e2ce03d007d8fc8e5a588cc729e06a4f411d/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTVRBd2VERXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--68498404813b89d3b5d057a53c9e28b3aa7b0916/560-69529-3.jpg",          "product_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdjRQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--3833e2ce03d007d8fc8e5a588cc729e06a4f411d/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTWpRd2VESTBNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--af499a4e491c8c250e2040c047974e5fef76d668/560-69529-3.jpg",          "large_url": "https://apfusion.com/rails/active_storage/representations/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBBdjRQIiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--3833e2ce03d007d8fc8e5a588cc729e06a4f411d/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaDdCam9MY21WemFYcGxTU0lOTmpBd2VEWXdNRDRHT2daRlZBPT0iLCJleHAiOm51bGwsInB1ciI6InZhcmlhdGlvbiJ9fQ==--408e8f9c4952e6c025d5d8b963ac4d98f48957b3/560-69529-3.jpg"        }      ],      "display_price": "$81.76",      "options_text": "",      "in_stock": true,      "is_backorderable": false,      "is_orderable": true,      "total_on_hand": 605,      "is_destroyed": false,      "product_images_url": "https://apfusion-prod.s3.us-east-2.amazonaws.com/DiHs3rbXJTKWqLcgDFpX675d?response-content-disposition=inline%3B%20filename%3D%2269423.jpg%22%3B%20filename%2A%3DUTF-8%27%2769423.jpg&response-content-type=image%2Fjpeg&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAIJIBG2UKKLWB7EUA%2F20220527%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20220527T140054Z&X-Amz-Expires=300&X-Amz-SignedHeaders=host&X-Amz-Signature=efd28f7f2a24c7fddba5f43ab9282299fba648788f8c08f40f305cc828a38967"    },    "single_display_amount": "$81.76",    "display_amount": "$81.76",    "total": "81.76",    "source_id": 96  }],"shipments": [  {    "id": 36828,    "tracking": "581819556986",    "number": "H57173957170",    "cost": "0.0",    "shipped_at": "2022-05-27T22:13:15.000Z",    "state": "shipped",    "shipping_rates": [      {        "id": 63146,        "name": "Free Shipping",        "cost": "0.0",        "selected": true,        "shipping_method_id": 12,        "shipping_method_code": null,        "display_cost": "$0.00"      },      {        "id": 63147,        "name": "Expedited Shipping",        "cost": "20.0",        "selected": false,        "shipping_method_id": 13,        "shipping_method_code": null,        "display_cost": "$20.00"      }    ],    "selected_shipping_rate": {      "id": 63146,      "name": "Free Shipping",      "cost": "0.0",      "selected": true,      "shipping_method_id": 12,      "shipping_method_code": null,      "display_cost": "$0.00"    },    "shipping_methods": [      {        "id": 12,        "code": null,        "name": "Free Shipping",        "linked_from": "Ground Shipping (FREE)",        "zones": [          {            "id": 33,            "name": "A95E0BA26B220015088D",            "description": null          }        ],        "shipping_categories": [          {            "id": 1,            "name": "Default"          }        ]      },      {        "id": 13,        "code": null,        "name": "Expedited Shipping",        "linked_from": "2-Day Shipping",        "zones": [          {            "id": 34,            "name": "9334BF4F77DE1216934E",            "description": null          }        ],        "shipping_categories": [          {            "id": 1,            "name": "Default"          }        ]      }    ],    "manifest": [      {        "variant_id": 96,        "quantity": 1,        "states": {          "shipped": 1        }      }    ],    "adjustments": [],    "order_id": "R252971375",    "stock_location_name": "Partners Fulfillment",    "shiping_method_name": {      "id": 12,      "name": "Free Shipping",      "display_on": "both",      "deleted_at": null,      "created_at": "2019-08-23T10:58:03.000Z",      "updated_at": "2019-08-23T10:58:03.000Z",      "tracking_url": null,      "admin_name": null,      "tax_category_id": 1,      "code": null,      "rate_table_id": 12,      "order_cutoff_time": null,      "handling_time": null,      "delivery_days": null,      "linked_from": "Ground Shipping (FREE)"    }  }]}]
      @order = Spree::ApfusionOrderConcern.create_apfusion_order(response)
    end

    describe "order" do
      it "should have a valid email" do
        expect(@order.email).to eq('James@CounselmanAuto.com')
      end

      it 'should have a special instructions' do
        expect(@order.special_instructions).to eq('APF: R252971375 - PL PO: 83888')
      end

      it 'should have a special instructions' do
        expect(@order.apfusion_completed_at).to eq('May 27, 2022 1:52 PM')
      end

      it 'should have a special instructions' do
        expect(@order.user_id).to eq(673)
      end

      it 'should match country in bill address' do
        country = Spree::Country.find_by_name('United States')
        expect(@order.bill_address.country_id).to eq(country.id)
      end

      it 'should match state in bill address' do
        state = Spree::State.find_by_name('Alabama')
        expect(@order.bill_address.state_id).to eq(state.id)
      end

      it 'should match phone in bill address' do
        expect(@order.bill_address.phone).to eq('251-330-2700')
      end

      it 'should match country in ship address' do
        country = Spree::Country.find_by_name('United States')
        expect(@order.ship_address.country_id).to eq(country.id)
      end

      it 'should match state in ship address' do
        state = Spree::State.find_by_name('Alabama')
        expect(@order.ship_address.state_id).to eq(state.id)
      end

      it 'should match phone in ship address' do
        expect(@order.ship_address.phone).to eq('251-330-2700')
      end

      it 'should have one line_item' do
        expect(@order.line_items.count).to eq(1)
      end

      it 'should match line item details' do
        line_item = @order.line_items.first
        expect(line_item.sku).to eq('560-69542')
        expect(line_item.price).to eq(81.76)
        expect(line_item.quantity).to eq(1)
      end

      it 'should match payments' do
        payment = @order.payments.first
        expect(payment.payment_method.name).to eq('Create at Apfusion')
        expect(payment.amount).to eq(81.76)
        expect(payment.state).to eq('checkout')
      end

      it 'should match shipments' do
        shipment = @order.shipments.first
        expect(shipment.apfusion_shipment_id).to eq('H57173957170')
        expect(shipment.cost).to eq(81.76)
        expect(shipment.state).to eq('ready')
      end

      it 'should match state' do
        expect(@order.state).to eq('complete')
        expect(@order.payment_state).to eq('balance_due')
        expect(@order.shipment_state).to eq('ready')
      end  
    end
  end
end

